---
name: hora-doc
description: Auto-generate API documentation from code — scan routes, extract Zod schemas, generate formatted docs. Use when user says doc, documentation, API docs, generate docs, swagger, openapi, document API, document routes. Do NOT use for README or general docs — write those manually. Do NOT use for code comments — that's not what this does.
metadata:
  author: HORA
  version: 1.0.0
compatibility: Claude Code. Next.js / Express / Hono with Zod. Node.js 18+. Cross-platform.
---

# Skill: hora-doc

> "La documentation qui se met a jour toute seule est la seule documentation qu'on lit."

Scan automatique des routes API, extraction des schemas Zod et des commentaires JSDoc, generation de documentation Markdown ou JSON/OpenAPI-like. Toujours synchronisee avec le code.

## Invocation

```
/hora-doc <commande> [options]
```

| Commande | Description |
|----------|-------------|
| `scan [dir]` | Scanne le projet et affiche les routes + schemas detectes |
| `generate [--format md\|json]` | Genere la documentation complete |
| `check` | Detecte les routes sans doc ou avec doc potentiellement perimee |

| Flag | Defaut | Description |
|------|--------|-------------|
| `--format` | `md` | Format de sortie : `md` (Markdown) ou `json` (structure JSON/OpenAPI-like) |
| `--output` | `.hora/api-docs.md` | Chemin du fichier de sortie (`-` pour stdout) |
| `--dir` | `.` | Repertoire du projet a scanner |

---

## Protocol

### Phase 1 — SCAN

1. Executer `scripts/scan-api-docs.ts` sur le repertoire du projet
2. Detecter les routes : Next.js App Router, Pages Router, Express, Hono
3. Pour chaque route, extraire en profondeur :
   - Methodes HTTP exportees
   - Schemas Zod et leurs champs (regex-based)
   - Commentaires JSDoc au-dessus des handlers
   - Indicateurs d'auth (`auth()`, `requireAuth`, `withAuth`, middleware detecte)
   - Exemples de requete / reponse si disponibles dans les commentaires

### Phase 2 — EXTRACT

Pour chaque fichier de route :
1. Parser les `z.object({...})` pour extraire les noms de champs et leurs types
2. Identifier les schemas de request body vs response
3. Extraire les query params depuis `searchParams`, `req.query`, ou les commentaires
4. Detecter les codes de statut retournes (`NextResponse.json(..., { status: 201 })`)

### Phase 3 — GENERATE

Selon le format choisi :

**Markdown** — Ecrit dans `.hora/api-docs.md` :
```
# API Documentation
> Auto-generated by hora-doc · <date>

## Endpoints

### GET /api/users
Description depuis JSDoc
**Auth:** Required
**Response:** `{ id: string, name: string, email: string }[]`
```

**JSON** — Structure OpenAPI-like :
```json
{
  "openapi": "3.0.0",
  "paths": {
    "/api/users": {
      "get": {
        "description": "...",
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "content": { ... } } }
      }
    }
  }
}
```

### Phase 4 — OUTPUT

- Ecrire dans `.hora/api-docs.md` (ou chemin specifie)
- Afficher un resume sur stderr : routes documentees, routes sans doc, champs detectes
- En mode `check` : lister uniquement les routes dont la doc est absente ou potentiellement perimee

---

## Exemples

### 1. Generer la doc d'un projet Next.js

```
/hora-doc generate
```

Scanne `app/api/`, extrait les schemas Zod, ecrit `.hora/api-docs.md`.

### 2. Generer un JSON/OpenAPI-like

```
/hora-doc generate --format json --output .hora/openapi.json
```

Utile pour importer dans Postman, Insomnia, ou un outil de visualisation.

### 3. Verifier si la doc est a jour

```
/hora-doc check
```

Liste les routes sans JSDoc, sans schema Zod, ou modifiees recemment sans mise a jour de la doc.

---

## Scripts

| Script | Usage |
|--------|-------|
| `scripts/scan-api-docs.ts` | `npx tsx scripts/scan-api-docs.ts [project-dir] [--format md\|json]` |

---

## Troubleshooting

### La doc generee est vide ou incomplete
- Verifier que les schemas Zod sont dans le meme fichier que le handler (ou imports directs)
- Ajouter des commentaires JSDoc au-dessus des fonctions pour enrichir la doc
- Les schemas inline `z.object({...})` sont mieux detectes que les schemas importes

### Les champs Zod ne sont pas detectes
- hora-doc utilise une extraction regex — les schemas multi-lignes complexes peuvent etre mal parsed
- Nommer les schemas avec le suffixe `Schema` : `const UserSchema = z.object({...})`
- Eviter les schemas generes dynamiquement

### Le check signale tout comme "perime"
- La detection de staleness est basee sur la date du fichier route vs la date de la doc
- Regenerer la doc apres chaque set de modifications avec `/hora-doc generate`

---

## Regles

1. **Lecture seule** — hora-doc ne modifie jamais les fichiers source
2. **Regex-based** — L'extraction Zod est approximative, pas un AST parser complet
3. **JSDoc enrichit** — Ajouter des commentaires JSDoc pour une doc plus precise
4. **Versionner la doc** — `.hora/api-docs.md` doit etre committe avec le code
